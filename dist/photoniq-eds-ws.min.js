!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PhotoniqEdsWs=t():e.PhotoniqEdsWs=t()}(this,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var i in r)e.o(r,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:r[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{connect:()=>m,create:()=>b});const r="x-photoniq-es";var i,s;!function(e){e.Open="open",e.Close="close",e.ConnectionId="connection-id",e.ServerQueryError="server-query-error",e.ServerGlobalError="server-global-error",e.ClientQueryError="client-query-error",e.ClientGlobalError="client-global-error",e.Message="message"}(i||(i={})),function(e){e.Closed="closed",e.Connecting="connecting",e.Open="open",e.Closing="closing"}(s||(s={}));var n=function(e,t,r,i){return new(r||(r=Promise))((function(s,n){function o(e){try{l(i.next(e))}catch(e){n(e)}}function c(e){try{l(i.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,c)}l((i=i.apply(e,t||[])).next())}))};function o(e){for(let t in e){let r=t.split(".");if(r.length<=1)continue;let i=e;for(let e=0;e<r.length;e++)void 0===i[r[e]]&&(i[r[e]]={}),e<r.length-1&&(i=i[r[e]]);i[r[r.length-1]]=e[t],delete e[t]}return e}function c(e){return n(this,void 0,void 0,(function*(){return new Promise(((t,r)=>{try{t(JSON.parse(e))}catch(i){try{(function(e){return n(this,void 0,void 0,(function*(){const t=Uint8Array.from(atob(e),(e=>e.charCodeAt(0))),r=new Blob([t],{type:"application/octet-stream"}),i=new DecompressionStream("gzip"),s=r.stream().pipeThrough(i),n=yield new Response(s);return yield n.text()}))})(e).then((e=>t(JSON.parse(e))))}catch(e){r(e)}}}))}))}class l{constructor(e,t){this.STUB_FILTER="%7B%22action%22%3A%22remove%22%2C%22queries%22%3A%5B%22SELECT%20%2A%20FROM%20fake%22%5D%7D",this.DEFAULT_PING_SECONDS=29,this.properties={},this.config=e,this.filtersState=t}connect(){let e=this;const t=`wss://${this.config.host}/api/es/v1/subscribe?type=collection&x-customer-id=${this.config.customerId}&apiKey=${this.config.apiKey}&fabric=${this.config.fabric}&filters=${this.STUB_FILTER}`;this.ws=new WebSocket(t),this.ws.addEventListener("open",(function(t){var r;null===(r=e.openListener)||void 0===r||r.call(e,t),e.updatePingInterval()})),this.ws.addEventListener("message",(function(t){var r;let i=e.handleMessage(t);i&&(null===(r=e.messageListener)||void 0===r||r.call(e,i)),e.updatePingInterval()})),this.ws.addEventListener("close",(function(t){var r;null===(r=e.closeListener)||void 0===r||r.call(e,t)})),this.ws.addEventListener("error",(function(t){var r;null===(r=e.errorListener)||void 0===r||r.call(e,t)}))}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}handleMessage(e){let t=this;if(t.properties[r])c(e.data).then((e=>{if(e.error){let r=e.error;const s="Error parsing SQL query:";if(r.startsWith(s)){let n=r.substring(s.length,r.indexOf("ERROR")).trim();const o={type:i.ServerQueryError,connection:t,data:void 0,code:e.code,message:r,query:n};let c=t.filtersState.filterForQuery(n);if(c)for(const e of c.querySets)t.filtersState.handleErrorListeners(e.errorCallbacks,n,o)}else{const s={type:i.ServerGlobalError,connection:t,data:void 0,code:e.code,message:r};t.filtersState.handleGlobalListener(s)}}else for(let r in e){let s=e[r],n=t.filtersState.filterForQuery(r);if(n){t.filtersState.increment(n);let e=Array.isArray(s);if(e)for(let e=0;e<s.length;e++)s[e]=o(s[e]);else s=[s];for(const o of n.querySets){if(e&&!o.initialData)continue;let n={type:i.Message,connection:t,data:s,query:r,count:o.count,retrieve:e};for(let e of o.callbacks)try{e(n)}catch(e){let s=`Error while handling data for query: ${r}`;const n={type:i.ClientQueryError,connection:t,data:e,message:s,query:r};t.filtersState.handleErrorListeners(o.errorCallbacks,r,n)}}let c=t.filtersState.tryToRemove(n,r);c&&t.send(c)}}}));else{const t=e.data.split("\n");for(const e of t){const t=e.split(":");2==t.length&&(this.properties[t[0].trim()]=t[1].trim())}}}onClose(e){this.closeListener=e,this.pingIntervalId&&clearInterval(this.pingIntervalId)}onError(e){this.errorListener=e}send(e){var t;this.status()===s.Open&&(null===(t=this.ws)||void 0===t||t.send(JSON.stringify(e)))}disconnect(){var e;null===(e=this.ws)||void 0===e||e.close()}status(){var e;switch(null===(e=this.ws)||void 0===e?void 0:e.readyState){case WebSocket.CONNECTING:return s.Connecting;case WebSocket.OPEN:return s.Open;case WebSocket.CLOSING:return s.Closing;default:return s.Closed}}getId(){return this.properties[r]}getProperty(e){return this.properties[e]}getProperties(){return this.properties}updatePingInterval(){var e;void 0!==this.pingIntervalId&&(clearInterval(this.pingIntervalId),this.pingIntervalId=void 0);let t=this;(!t.config.pingSeconds||t.config.pingSeconds>0)&&(this.pingIntervalId=setInterval((()=>{var e;t.status()===s.Open&&(null===(e=t.ws)||void 0===e||e.send("{1}"))}),1e3*(null!==(e=t.config.pingSeconds)&&void 0!==e?e:this.DEFAULT_PING_SECONDS)))}}class a{constructor(e,t){this.properties={},this.url=e,this.headers=t}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}onError(e){this.errorListener=e}onClose(e){this.closeListener=e}connect(e){return t=this,r=void 0,s=function*(){var t,r,i,s,n;try{const n=yield fetch(this.url,{method:"POST",headers:this.headers,body:JSON.stringify(e)});n.ok?null===(r=this.openListener)||void 0===r||r.call(this,n):null===(t=this.errorListener)||void 0===t||t.call(this,n);const o=n.body;let c,l="";for(this.reader=o.getReader();!(c=yield this.reader.read()).done;){let e=new TextDecoder("utf-8").decode(c.value);l+=e;let t=l.indexOf("\n\n");if(t>-1){let r=l.substring(0,t);if(l=l.substring(t+2),r.startsWith(":")){const t=e.split("\n");for(const e of t){const t=e.split(":");3==t.length&&(this.properties[t[1].trim()]=t[2].trim())}}else{let e=r.indexOf(":");if(e>-1){let t=r.substring(0,e).trim();" "===r[e+1]&&e++,e++;let s=r.substring(e).replace(/\ndata: ?/g,"\n");"data"===t?null===(i=this.messageListener)||void 0===i||i.call(this,s):console.warn(`Not supported message with type of message ${t}: ${s}`)}}}}null===(s=this.closeListener)||void 0===s||s.call(this,"Connection closed")}catch(e){null===(n=this.errorListener)||void 0===n||n.call(this,e)}},new((i=void 0)||(i=Promise))((function(e,n){function o(e){try{l(s.next(e))}catch(e){n(e)}}function c(e){try{l(s.throw(e))}catch(e){n(e)}}function l(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(o,c)}l((s=s.apply(t,r||[])).next())}));var t,r,i,s}disconnect(){var e;null===(e=this.reader)||void 0===e||e.cancel()}getProperty(e){return this.properties[e]}getProperties(){return this.properties}}const u="FALSE",h="TRUE",d="add",f="remove";class p{constructor(e){this.queries=new Map,this.globalListener=e}calculateFilter(e,t,r){return{action:e,queries:[t],initialData:r.querySets.some((e=>e.initialData&&0===e.count))?h:void 0,once:r.querySets.every((e=>e.once))?h:void 0,compress:r.querySets.some((e=>e.compress))?h:void 0}}increment(e){for(const t of e.querySets)t.count++}tryToRemove(e,t){if(e.querySets.every((e=>e.once)))return this.queries.delete(t),{action:f,queries:[t]}}equalFiltersWithoutQueries(e,t){return e.action===t.action&&e.compress===t.compress&&e.initialData===t.initialData&&e.once===t.once}addQueries(e,t,r,i,s){let n=[];for(const o of e){let e=this.queries.get(o.query);if(e){let c=this.calculateFilter(d,o.query,e),l=e.querySets.find((e=>e.querySet===s));if(l)l.initialData=t,l.once=r,l.compress=i,t&&(l.count=0),-1==l.callbacks.indexOf(o.listener)&&l.callbacks.push(o.listener),-1==l.errorCallbacks.indexOf(o.errorListener)&&l.errorCallbacks.push(o.errorListener);else{let n=[];o.listener&&n.push(o.listener);let c=[];o.errorListener&&c.push(o.errorListener),e.querySets.push({querySet:s,initialData:t,compress:i,once:r,count:0,callbacks:o.listener?[o.listener]:[],errorCallbacks:o.errorListener?[o.errorListener]:[]})}let a=this.calculateFilter(d,o.query,e);if(!this.equalFiltersWithoutQueries(c,a)){let e=n.find((e=>this.equalFiltersWithoutQueries(e,a)));e?e.queries.push(o.query):n.push(a)}}else{let e={querySets:[{querySet:s,initialData:t,compress:i,once:r,count:0,callbacks:o.listener?[o.listener]:[],errorCallbacks:o.errorListener?[o.errorListener]:[]}]};this.queries.set(o.query,e);let c=this.calculateFilter(d,o.query,e),l=n.find((e=>this.equalFiltersWithoutQueries(e,c)));l?l.queries.push(o.query):n.push(c)}}return n}filterForQuery(e){return this.queries.get(e)}removeAllQueries(e){let t=Array.from(this.queries.keys());return this.removeQueries(t,e)}removeQueries(e,t){let r=[];for(const i of e){let e=!0,s=this.queries.get(i);if(s){let r=s.querySets.findIndex((e=>e.querySet===t));r>-1&&s.querySets.splice(r,1),s.querySets.length&&(e=!1)}e&&(this.queries.delete(i),r.push(i))}if(r.length)return{action:f,queries:r}}activeFilters(){let e=[];for(const[t,r]of this.queries){const i=this.calculateFilter(d,t,r);let s=e.find((e=>this.equalFiltersWithoutQueries(e,i)));s?s.queries.push(t):e.push(i)}return e}handleErrorListeners(e,t,r){for(let i of e)try{i(r)}catch(e){console.warn(`Error while handling error listener for query: ${t}`,e)}}handleGlobalListener(e){var t;try{null===(t=this.globalListener)||void 0===t||t.call(this,e)}catch(e){console.warn("Error while handling global error listener",e)}}}class v{constructor(e,t){this.opened=!1,this.config=e,this.filtersState=t,this.url=`https://${this.config.host}/api/es/sse/v1/subscribe`,this.headers={"Content-Type":"application/json",Authorization:`${this.config.apiKey}`,"x-customer-id":`${this.config.customerId}`}}send(e){if(e&&this.opened){this.disconnect();let e=this.filtersState.activeFilters();this.retrieve(e)}}connect(){var e;if(this.opened)throw Error("SSE connection already opened");this.opened=!0,null===(e=this.openListener)||void 0===e||e.call(this,"SSE connection opened")}retrieve(e){var t;this.opened||(this.opened=!0,null===(t=this.openListener)||void 0===t||t.call(this,"SSE connection opened"));let r=e.filter((e=>e.initialData===h)).map((e=>e.queries)).reduce(((e,t)=>e.concat(t)),[]);if(!r.length)return void this.subscribe(e);let s={type:"collection",fabric:this.config.fabric,filters:{once:h,compress:u,initialData:h,queries:r}},n=this;this.eventSource=new a(this.url,this.headers),this.eventSource.onError((e=>{const t={type:i.ClientGlobalError,connection:n,data:e};this.filtersState.handleGlobalListener(t)})),this.eventSource.onMessage((t=>{n.handleMessage(t).then((t=>{var r;t&&(null===(r=n.eventSource)||void 0===r||r.disconnect(),n.subscribe(e))}))})),this.eventSource.connect(s)}subscribe(e){var t;this.opened||(this.opened=!0,null===(t=this.openListener)||void 0===t||t.call(this,"SSE connection opened"));let r=e.filter((e=>e.once!==h)).map((e=>e.queries)).reduce(((e,t)=>e.concat(t)),[]);if(!r.length)return;let s={type:"collection",fabric:this.config.fabric,filters:{once:u,compress:u,initialData:u,queries:r}},n=this;this.eventSource=new a(this.url,this.headers),this.eventSource.onError((e=>{const t={type:i.ClientGlobalError,connection:n,data:e};this.filtersState.handleGlobalListener(t)})),this.eventSource.onMessage((e=>{n.handleMessage(e)})),this.eventSource.onClose((e=>{var t;this.opened&&(this.opened=!1,null===(t=n.closeListener)||void 0===t||t.call(n,e))})),this.eventSource.connect(s)}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}onClose(e){this.closeListener=e}onError(e){this.errorListener=e}status(){return this.opened?s.Open:s.Closed}disconnect(){var e;null===(e=this.eventSource)||void 0===e||e.disconnect(),this.eventSource=void 0}getId(){return this.getProperty(r)}getProperty(e){var t;return null===(t=this.eventSource)||void 0===t?void 0:t.getProperty(e)}getProperties(){return this.eventSource?this.eventSource.getProperties():{}}handleMessage(e){return c(e).then((e=>{if(!e.error){for(let t in e){let r=e[t],s=this.filtersState.filterForQuery(t);if(s){this.filtersState.increment(s);let e=Array.isArray(r);if(e)for(let e=0;e<r.length;e++)r[e]=o(r[e]);else r=[r];for(const n of s.querySets){if(e&&!n.initialData)continue;let s={type:i.Message,connection:this,data:r,query:t,count:n.count,retrieve:e};for(let e of n.callbacks)try{e(s)}catch(e){let r=`Error while handling data for query: ${t}`;const s={type:i.ClientQueryError,connection:this,data:e,message:r,query:t};this.filtersState.handleErrorListeners(n.errorCallbacks,t,s)}}this.filtersState.tryToRemove(s,t)}}return!0}{let t=e.error;const r="Error parsing SQL query:";if(t.startsWith(r)){let s=t.substring(r.length,t.indexOf("ERROR")).trim();const n={type:i.ServerQueryError,connection:this,data:void 0,code:e.code,message:t,query:s};let o=this.filtersState.filterForQuery(s);if(o)for(const e of o.querySets)this.filtersState.handleErrorListeners(e.errorCallbacks,s,n)}else{const r={type:i.ServerGlobalError,connection:this,data:void 0,code:e.code,message:t};this.filtersState.handleGlobalListener(r)}}return!1}))}}class y{constructor(e,t,r){this.subscribeQueries=[],this.retrieveAndSubscribeQueries=[],this.retrieveQueries=[],this.unsubscribeQueries=[],this.querySet=e,this.connection=t,this.filtersState=r}subscribe(e,t,r){return this.subscribeQueries.push({query:e,listener:t,errorListener:r,compress:!1}),this}retrieveAndSubscribe(e,t,r,i){return this.retrieveAndSubscribeQueries.push({query:e,listener:t,errorListener:r,compress:!0===i}),this}retrieve(e,t,r,i){return this.retrieveQueries.push({query:e,listener:t,errorListener:r,compress:!0===i}),this}unsubscribe(e){return this.unsubscribeQueries.push(e),this}assemble(){let e=this.retrieveQueries.some((e=>e.compress)),t=this.filtersState.addQueries(this.retrieveQueries,!0,!0,e,this.querySet),r=this.retrieveAndSubscribeQueries.some((e=>e.compress)),i=this.filtersState.addQueries(this.retrieveAndSubscribeQueries,!0,!1,r,this.querySet);this.joinFilters(t,i);let s=this.filtersState.addQueries(this.subscribeQueries,!1,!1,!1,this.querySet);this.joinFilters(t,s);for(const e of t)this.connection.send(e);let n=this.filtersState.removeQueries(this.unsubscribeQueries,this.querySet);n&&this.connection.send(n)}joinFilters(e,t){for(const r of t){let t=e.find((e=>this.filtersState.equalFiltersWithoutQueries(e,r)));t?t.queries.push(...r.queries):e.push(r)}}}class g{constructor(e,t){this.connection=e,this.filtersState=t}subscribe(e,t,r){let i=[{query:e,listener:t,errorListener:r,compress:!1}],s=this.filtersState.addQueries(i,!1,!1,!1,this);for(const e of s)this.connection.send(e)}retrieveAndSubscribe(e,t,r,i){let s=[{query:e,listener:t,errorListener:r,compress:!0===i}],n=this.filtersState.addQueries(s,!0,!1,!0===i,this);for(const e of n)this.connection.send(e)}retrieve(e,t,r,i){let s=[{query:e,listener:t,errorListener:r,compress:!0===i}],n=this.filtersState.addQueries(s,!0,!0,!0===i,this);for(const e of n)this.connection.send(e)}unsubscribe(e){let t=this.filtersState.removeQueries([e],this);t&&this.connection.send(t)}unsubscribeAll(){let e=this.filtersState.removeAllQueries(this);e&&this.connection.send(e)}batch(){return new y(this,this.connection,this.filtersState)}}class S{constructor(e,t){this.connectionTypes=["ws"],this.reconnection=-1,this.config=e,this.filtersState=new p(t)}connect(){var e;if(this.connection)throw new Error(`Already connected with status: ${this.status()}`);(null===(e=this.config.connectionTypes)||void 0===e?void 0:e.length)&&(this.connectionTypes=this.config.connectionTypes);let t=this.connectionTypes[this.reconnection%this.connectionTypes.length];switch(t){case"ws":this.connection=new l(this.config,this.filtersState);break;case"sse":this.connection=new v(this.config,this.filtersState);break;default:throw new Error(`Connection type not supported: ${t}`)}let r=this;this.connection.onOpen((function(e){var t;let s=r.reconnection;if(r.reconnection=0,-1===s){const t={type:i.Open,connection:r,data:e};r.filtersState.handleGlobalListener(t)}let n=r.filtersState.activeFilters();for(const e of n)null===(t=r.connection)||void 0===t||t.send(e)})),this.connection.onMessage((function(e){})),this.connection.onError((function(e){})),this.connection.onClose((function(e){if(r.connection=void 0,r.reconnection>-1){let e=Math.pow(2,6+r.reconnection++);setTimeout((function(){r.connect()}),e)}else{r.reconnection=0;const t={type:i.Close,connection:r,data:e};r.filtersState.handleGlobalListener(t)}})),this.connection.connect()}send(e){var t;null===(t=this.connection)||void 0===t||t.send(e)}disconnect(){var e;this.reconnection=-1,null===(e=this.connection)||void 0===e||e.disconnect()}getConfig(){return this.config}status(){return this.connection?this.connection.status():s.Closed}getId(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getId()}getProperty(e){var t;return null===(t=this.connection)||void 0===t?void 0:t.getProperty(e)}getProperties(){return this.connection?this.connection.getProperties():{}}querySet(){return new g(this,this.filtersState)}}function b(e,t){return new S(e,t)}function m(e,t){let r=new S(e,t);return r.connect(),r}return t})()));