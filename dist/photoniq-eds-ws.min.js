!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PhotoniqEdsWs=t():e.PhotoniqEdsWs=t()}(this,(()=>(()=>{"use strict";var e={20:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionManager=void 0;const r=n(613),i=n(721),s=n(759),o=n(235);t.ConnectionManager=class{constructor(e,t){this.config=e,this.filtersState=new o.FiltersState(t),this.connection=new s.SwitchableConnection(this.config,this.filtersState)}connect(){let e=this;this.connection.connect(),this.connection.onOpen((function(t){const n={type:r.EDSEventType.Open,connection:e,data:t};e.filtersState.handleGlobalListener(n)})),this.connection.onMessage((function(e){})),this.connection.onClose((function(t){const n={type:r.EDSEventType.Close,connection:e,data:t};e.filtersState.handleGlobalListener(n)})),this.connection.onError((function(t){const n={type:r.EDSEventType.ClientGlobalError,connection:e,data:t,message:"Client error"};e.filtersState.handleGlobalListener(n)}))}send(e){this.connection.send(e)}querySet(){return new i.QuerySet(this,this.filtersState)}disconnect(){this.connection.disconnect()}getConfig(){return this.config}getId(){return this.connection.getId()}status(){return this.connection.status()}getProperty(e){return this.connection.getProperty(e)}getProperties(){return this.connection.getProperties()}}},235:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FiltersState=t.REMOVE=t.ADD=t.TRUE=t.FALSE=void 0,t.FALSE="FALSE",t.TRUE="TRUE",t.ADD="add",t.REMOVE="remove",t.FiltersState=class{constructor(e){this.queries=new Map,this.globalListener=e}calculateFilter(e,n,r){return{action:e,queries:[n],initialData:r.querySets.some((e=>e.initialData&&0===e.count))?t.TRUE:void 0,once:r.querySets.every((e=>e.once))?t.TRUE:void 0,compress:r.querySets.some((e=>e.compress))?t.TRUE:void 0}}increment(e){for(const t of e.querySets)t.count++}tryToRemove(e,n){if(e.querySets.every((e=>e.once)))return this.queries.delete(n),{action:t.REMOVE,queries:[n]}}equalFiltersWithoutQueries(e,t){return e.action===t.action&&e.compress===t.compress&&e.initialData===t.initialData&&e.once===t.once}addQueries(e,n,r,i,s){let o=[];for(const c of e){let e=this.queries.get(c.query);if(e){let l=this.calculateFilter(t.ADD,c.query,e),a=e.querySets.find((e=>e.querySet===s));if(a)a.initialData=n,a.once=r,a.compress=i,n&&(a.count=0),-1==a.callbacks.indexOf(c.listener)&&a.callbacks.push(c.listener),-1==a.errorCallbacks.indexOf(c.errorListener)&&a.errorCallbacks.push(c.errorListener);else{let t=[];c.listener&&t.push(c.listener);let o=[];c.errorListener&&o.push(c.errorListener),e.querySets.push({querySet:s,initialData:n,compress:i,once:r,count:0,callbacks:c.listener?[c.listener]:[],errorCallbacks:c.errorListener?[c.errorListener]:[]})}let u=this.calculateFilter(t.ADD,c.query,e);if(!this.equalFiltersWithoutQueries(l,u)){let e=o.find((e=>this.equalFiltersWithoutQueries(e,u)));e?e.queries.push(c.query):o.push(u)}}else{let e={querySets:[{querySet:s,initialData:n,compress:i,once:r,count:0,callbacks:c.listener?[c.listener]:[],errorCallbacks:c.errorListener?[c.errorListener]:[]}]};this.queries.set(c.query,e);let l=this.calculateFilter(t.ADD,c.query,e),a=o.find((e=>this.equalFiltersWithoutQueries(e,l)));a?a.queries.push(c.query):o.push(l)}}return o}filterForQuery(e){return this.queries.get(e)}removeAllQueries(e){let t=Array.from(this.queries.keys());return this.removeQueries(t,e)}removeQueries(e,n){let r=[];for(const t of e){let e=!0,i=this.queries.get(t);if(i){let t=i.querySets.findIndex((e=>e.querySet===n));t>-1&&i.querySets.splice(t,1),i.querySets.length&&(e=!1)}e&&(this.queries.delete(t),r.push(t))}if(r.length)return{action:t.REMOVE,queries:r}}activeFilters(){let e=[];for(const[n,r]of this.queries){const i=this.calculateFilter(t.ADD,n,r);let s=e.find((e=>this.equalFiltersWithoutQueries(e,i)));s?s.queries.push(n):e.push(i)}return e}handleErrorListeners(e,t,n){for(let r of e)try{r(n)}catch(e){console.warn(`Error while handling error listener for query: ${t}`,e)}}handleGlobalListener(e){var t;try{null===(t=this.globalListener)||void 0===t||t.call(this,e)}catch(e){console.warn("Error while handling global error listener",e)}}}},977:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueryBatch=void 0,t.QueryBatch=class{constructor(e,t,n){this.subscribeQueries=[],this.retrieveAndSubscribeQueries=[],this.retrieveQueries=[],this.unsubscribeQueries=[],this.querySet=e,this.connection=t,this.filtersState=n}subscribe(e,t,n){return this.subscribeQueries.push({query:e,listener:t,errorListener:n}),this}retrieveAndSubscribe(e,t,n){return this.retrieveAndSubscribeQueries.push({query:e,listener:t,errorListener:n}),this}retrieve(e,t,n){return this.retrieveQueries.push({query:e,listener:t,errorListener:n}),this}unsubscribe(e){return this.unsubscribeQueries.push(e),this}assemble(){let e=this.filtersState.addQueries(this.retrieveQueries,!0,!0,!1,this.querySet),t=this.filtersState.addQueries(this.retrieveAndSubscribeQueries,!0,!1,!1,this.querySet);this.joinFilters(e,t);let n=this.filtersState.addQueries(this.subscribeQueries,!1,!1,!1,this.querySet);this.joinFilters(e,n);for(const t of e)this.connection.send(JSON.stringify(t));let r=this.filtersState.removeQueries(this.unsubscribeQueries,this.querySet);r&&this.connection.send(JSON.stringify(r))}joinFilters(e,t){for(const n of t){let t=e.find((e=>this.filtersState.equalFiltersWithoutQueries(e,n)));t?t.queries.push(...n.queries):e.push(n)}}}},721:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QuerySet=void 0;const r=n(977);t.QuerySet=class{constructor(e,t){this.connection=e,this.filtersState=t}subscribe(e,t,n){let r=[{query:e,listener:t,errorListener:n}],i=this.filtersState.addQueries(r,!1,!1,!1,this);for(const e of i)this.connection.send(JSON.stringify(e))}retrieveAndSubscribe(e,t,n){let r=[{query:e,listener:t,errorListener:n}],i=this.filtersState.addQueries(r,!0,!1,!1,this);for(const e of i)this.connection.send(JSON.stringify(e))}retrieve(e,t,n){let r=[{query:e,listener:t,errorListener:n}],i=this.filtersState.addQueries(r,!0,!0,!1,this);for(const e of i)this.connection.send(JSON.stringify(e))}unsubscribe(e){let t=this.filtersState.removeQueries([e],this);t&&this.connection.send(JSON.stringify(t))}unsubscribeAll(){let e=this.filtersState.removeAllQueries(this);e&&this.connection.send(JSON.stringify(e))}batch(){return new r.QueryBatch(this,this.connection,this.filtersState)}}},666:function(e,t){var n=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{l(r.next(e))}catch(e){s(e)}}function c(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,c)}l((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.EventSource=void 0,t.EventSource=class{constructor(e,t){this.url=e,this.headers=t}onopen(e){this.openListener=e}onmessage(e){this.messageListener=e}onerror(e){this.errorListener=e}onclose(e){this.closeListener=e}connect(e){return n(this,void 0,void 0,(function*(){try{const t=yield fetch(this.url,{method:"POST",headers:this.headers,body:JSON.stringify(e)});if(!t.ok)throw new Error("Network response was not ok");const n=t.body.getReader();let r;for(;!(r=yield n.read()).done;){let e=new TextDecoder("utf-8").decode(r.value);console.log("Response data:",e)}}catch(e){console.error("There was a problem with the fetch operation:",e)}}))}}},400:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SseConnection=void 0;const r=n(613),i=n(666);t.SseConnection=class{constructor(e){this.config=e}send(e){}connect(){const e=`https://${this.config.host}/api/es/sse/v1/subscribe`;this.sse=new i.EventSource(e,{"Content-Type":"application/json",Authorization:`${this.config.apiKey}`,"x-customer-id":`${this.config.customerId}`}),this.sse.onopen=e=>{console.log("Connection to SSE server opened.",e)},this.sse.onmessage=e=>{console.log("Received event:",e)},this.sse.onerror=e=>{console.error("Error occurred:",e)},this.sse.connect({type:"collection",fabric:"_system",filters:{once:"FALSE",compress:"FALSE",initialData:"TRUE",queries:["select * from box_trim where attendance=4"]}})}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}onClose(e){this.closeListener=e}onError(e){this.errorListener=e}status(){return r.ConnectionStatus.Closed}disconnect(){}getId(){}getProperty(e){}getProperties(){return{}}}},759:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SwitchableConnection=void 0;const r=n(613),i=n(890),s=n(400);t.SwitchableConnection=class{constructor(e,t){this.connectionTypes=["ws"],this.reconnection=-1,this.config=e,this.filtersState=t}connect(){if(this.connection)throw new Error(`Already connected with status: ${this.status()}`);if(this.config.primaryConnection){let e=this.connectionTypes.indexOf(this.config.primaryConnection);if(-1===e)throw new Error(`Wrong connection type set as primaryConnection: ${this.config.primaryConnection}`);const[t]=this.connectionTypes.splice(e,1);this.connectionTypes.unshift(t)}let e=this.connectionTypes[this.reconnection%this.connectionTypes.length];switch(e){case"ws":this.connection=new i.WsConnection(this.config,this.filtersState);break;case"sse":this.connection=new s.SseConnection(this.config);break;default:throw new Error(`Connection type not supported: ${e}`)}let t=this;this.connection.onOpen((function(e){var n,r;let i=t.reconnection;t.reconnection=0,-1===i&&(null===(n=t.openListener)||void 0===n||n.call(t,e));let s=t.filtersState.activeFilters();for(const e of s)null===(r=t.connection)||void 0===r||r.send(JSON.stringify(e))})),this.connection.onMessage((function(e){var n;null===(n=t.messageListener)||void 0===n||n.call(t,e)})),this.connection.onError((function(e){var n;null===(n=t.errorListener)||void 0===n||n.call(t,e)})),this.connection.onClose((function(e){var n;if(t.connection=void 0,t.reconnection>-1){let e=Math.pow(2,6+t.reconnection++);setTimeout((function(){t.connect()}),e)}else t.reconnection=0,null===(n=t.closeListener)||void 0===n||n.call(t,e)})),this.connection.connect()}send(e){var t;null===(t=this.connection)||void 0===t||t.send(e)}disconnect(){var e;this.reconnection=-1,null===(e=this.connection)||void 0===e||e.disconnect()}status(){return this.connection?this.connection.status():r.ConnectionStatus.Closed}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}onClose(e){this.closeListener=e}onError(e){this.errorListener=e}getId(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getId()}getProperty(e){var t;return null===(t=this.connection)||void 0===t?void 0:t.getProperty(e)}getProperties(){return this.connection?this.connection.getProperties():{}}}},613:(e,t)=>{var n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.ConnectionStatus=t.EDSEventType=t.PHOTONIQ_ES=void 0,t.PHOTONIQ_ES="x-photoniq-es",function(e){e.Open="open",e.Close="close",e.ConnectionId="connection-id",e.ServerQueryError="server-query-error",e.ServerGlobalError="server-global-error",e.ClientQueryError="client-query-error",e.ClientGlobalError="client-global-error",e.Message="message"}(n||(t.EDSEventType=n={})),function(e){e.Closed="closed",e.Connecting="connecting",e.Open="open",e.Closing="closing"}(r||(t.ConnectionStatus=r={}))},890:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WsConnection=void 0;const r=n(613);t.WsConnection=class{constructor(e,t){this.STUB_FILTER="%7B%22action%22%3A%22remove%22%2C%22queries%22%3A%5B%22SELECT%20%2A%20FROM%20fake%22%5D%7D",this.DEFAULT_PING_SECONDS=29,this.properties={},this.config=e,this.filtersState=t}connect(){let e=this;const t=`wss://${this.config.host}/api/es/v1/subscribe?type=collection&x-customer-id=${this.config.customerId}&apiKey=${this.config.apiKey}&fabric=${this.config.fabric}&filters=${this.STUB_FILTER}`;this.ws=new WebSocket(t),this.ws.addEventListener("open",(function(t){var n;null===(n=e.openListener)||void 0===n||n.call(e,t),e.updatePingInterval()})),this.ws.addEventListener("message",(function(t){var n;let r=e.handleMessage(t);r&&(null===(n=e.messageListener)||void 0===n||n.call(e,r)),e.updatePingInterval()})),this.ws.addEventListener("close",(function(t){var n;null===(n=e.closeListener)||void 0===n||n.call(e,t)})),this.ws.addEventListener("error",(function(t){var n;null===(n=e.errorListener)||void 0===n||n.call(e,t)}))}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}handleMessage(e){let t=this;if(t.properties[r.PHOTONIQ_ES]){let n=JSON.parse(e.data);if(n.error){let e=n.error;const i="Error parsing SQL query:";if(e.startsWith(i)){let s=e.substring(i.length,e.indexOf("ERROR")).trim();const o={type:r.EDSEventType.ServerQueryError,connection:t,data:void 0,code:n.code,message:e,query:s};let c=t.filtersState.filterForQuery(s);if(c)for(const e of c.querySets)t.filtersState.handleErrorListeners(e.errorCallbacks,s,o)}else{const i={type:r.EDSEventType.ServerGlobalError,connection:t,data:void 0,code:n.code,message:e};t.filtersState.handleGlobalListener(i)}}else for(let e in n){let i=n[e],s=t.filtersState.filterForQuery(e);if(s){t.filtersState.increment(s);let n=Array.isArray(i);if(n)for(let e=0;e<i.length;e++)i[e]=t.convertInitialData(i[e]);else i=[i];for(const o of s.querySets){if(n&&!o.initialData)continue;let s={type:r.EDSEventType.Message,connection:t,data:i,query:e,count:o.count,retrieve:n};for(let n of o.callbacks)try{n(s)}catch(n){let i=`Error while handling data for query: ${e}`;const s={type:r.EDSEventType.ClientQueryError,connection:t,data:n,message:i,query:e};t.filtersState.handleErrorListeners(o.errorCallbacks,e,s)}}let o=t.filtersState.tryToRemove(s,e);o&&t.send(JSON.stringify(o))}}}else{const t=e.data.split("\n");for(const e of t){const t=e.split(":");2==t.length&&(this.properties[t[0].trim()]=t[1].trim())}}}onClose(e){this.closeListener=e,this.pingIntervalId&&clearInterval(this.pingIntervalId)}onError(e){this.errorListener=e}send(e){var t;this.status()===r.ConnectionStatus.Open&&(null===(t=this.ws)||void 0===t||t.send(e))}disconnect(){var e;null===(e=this.ws)||void 0===e||e.close()}status(){var e;switch(null===(e=this.ws)||void 0===e?void 0:e.readyState){case WebSocket.CONNECTING:return r.ConnectionStatus.Connecting;case WebSocket.OPEN:return r.ConnectionStatus.Open;case WebSocket.CLOSING:return r.ConnectionStatus.Closing;default:return r.ConnectionStatus.Closed}}getId(){return this.properties[r.PHOTONIQ_ES]}getProperty(e){return this.properties[e]}getProperties(){return this.properties}updatePingInterval(){var e;void 0!==this.pingIntervalId&&(clearInterval(this.pingIntervalId),this.pingIntervalId=void 0);let t=this;(!t.config.pingSeconds||t.config.pingSeconds>0)&&(this.pingIntervalId=setInterval((()=>{t.send("{1}")}),1e3*(null!==(e=t.config.pingSeconds)&&void 0!==e?e:this.DEFAULT_PING_SECONDS)))}convertInitialData(e){for(let t in e){let n=t.split(".");if(n.length<=1)continue;let r=e;for(let e=0;e<n.length;e++)void 0===r[n[e]]&&(r[n[e]]={}),e<n.length-1&&(r=r[n[e]]);r[n[n.length-1]]=e[t],delete e[t]}return e}}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,n),s.exports}var r={};return(()=>{var e=r;Object.defineProperty(e,"__esModule",{value:!0}),e.connect=void 0;const t=n(20);e.connect=function(e,n){let r=new t.ConnectionManager(e,n);return r.connect(),r}})(),r})()));