!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PhotoniqEdsWs=t():e.PhotoniqEdsWs=t()}(this,(()=>(()=>{"use strict";var e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{connect:()=>S,create:()=>y});const r="x-photoniq-es";var s,i;function n(e){for(let t in e){let r=t.split(".");if(r.length<=1)continue;let s=e;for(let e=0;e<r.length;e++)void 0===s[r[e]]&&(s[r[e]]={}),e<r.length-1&&(s=s[r[e]]);s[r[r.length-1]]=e[t],delete e[t]}return e}!function(e){e.Open="open",e.Close="close",e.ConnectionId="connection-id",e.ServerQueryError="server-query-error",e.ServerGlobalError="server-global-error",e.ClientQueryError="client-query-error",e.ClientGlobalError="client-global-error",e.Message="message"}(s||(s={})),function(e){e.Closed="closed",e.Connecting="connecting",e.Open="open",e.Closing="closing"}(i||(i={}));class o{constructor(e,t){this.STUB_FILTER="%7B%22action%22%3A%22remove%22%2C%22queries%22%3A%5B%22SELECT%20%2A%20FROM%20fake%22%5D%7D",this.DEFAULT_PING_SECONDS=29,this.properties={},this.config=e,this.filtersState=t}connect(){let e=this;const t=`wss://${this.config.host}/api/es/v1/subscribe?type=collection&x-customer-id=${this.config.customerId}&apiKey=${this.config.apiKey}&fabric=${this.config.fabric}&filters=${this.STUB_FILTER}`;this.ws=new WebSocket(t),this.ws.addEventListener("open",(function(t){var r;null===(r=e.openListener)||void 0===r||r.call(e,t),e.updatePingInterval()})),this.ws.addEventListener("message",(function(t){var r;let s=e.handleMessage(t);s&&(null===(r=e.messageListener)||void 0===r||r.call(e,s)),e.updatePingInterval()})),this.ws.addEventListener("close",(function(t){var r;null===(r=e.closeListener)||void 0===r||r.call(e,t)})),this.ws.addEventListener("error",(function(t){var r;null===(r=e.errorListener)||void 0===r||r.call(e,t)}))}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}handleMessage(e){let t=this;if(t.properties[r]){let r=JSON.parse(e.data);if(r.error){let e=r.error;const i="Error parsing SQL query:";if(e.startsWith(i)){let n=e.substring(i.length,e.indexOf("ERROR")).trim();const o={type:s.ServerQueryError,connection:t,data:void 0,code:r.code,message:e,query:n};let l=t.filtersState.filterForQuery(n);if(l)for(const e of l.querySets)t.filtersState.handleErrorListeners(e.errorCallbacks,n,o)}else{const i={type:s.ServerGlobalError,connection:t,data:void 0,code:r.code,message:e};t.filtersState.handleGlobalListener(i)}}else for(let e in r){let i=r[e],o=t.filtersState.filterForQuery(e);if(o){t.filtersState.increment(o);let r=Array.isArray(i);if(r)for(let e=0;e<i.length;e++)i[e]=n(i[e]);else i=[i];for(const n of o.querySets){if(r&&!n.initialData)continue;let o={type:s.Message,connection:t,data:i,query:e,count:n.count,retrieve:r};for(let r of n.callbacks)try{r(o)}catch(r){let i=`Error while handling data for query: ${e}`;const o={type:s.ClientQueryError,connection:t,data:r,message:i,query:e};t.filtersState.handleErrorListeners(n.errorCallbacks,e,o)}}let l=t.filtersState.tryToRemove(o,e);l&&t.send(l)}}}else{const t=e.data.split("\n");for(const e of t){const t=e.split(":");2==t.length&&(this.properties[t[0].trim()]=t[1].trim())}}}onClose(e){this.closeListener=e,this.pingIntervalId&&clearInterval(this.pingIntervalId)}onError(e){this.errorListener=e}send(e){var t;this.status()===i.Open&&(null===(t=this.ws)||void 0===t||t.send(JSON.stringify(e)))}disconnect(){var e;null===(e=this.ws)||void 0===e||e.close()}status(){var e;switch(null===(e=this.ws)||void 0===e?void 0:e.readyState){case WebSocket.CONNECTING:return i.Connecting;case WebSocket.OPEN:return i.Open;case WebSocket.CLOSING:return i.Closing;default:return i.Closed}}getId(){return this.properties[r]}getProperty(e){return this.properties[e]}getProperties(){return this.properties}updatePingInterval(){var e;void 0!==this.pingIntervalId&&(clearInterval(this.pingIntervalId),this.pingIntervalId=void 0);let t=this;(!t.config.pingSeconds||t.config.pingSeconds>0)&&(this.pingIntervalId=setInterval((()=>{var e;t.status()===i.Open&&(null===(e=t.ws)||void 0===e||e.send("{1}"))}),1e3*(null!==(e=t.config.pingSeconds)&&void 0!==e?e:this.DEFAULT_PING_SECONDS)))}}class l{constructor(e,t){this.properties={},this.url=e,this.headers=t}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}onError(e){this.errorListener=e}onClose(e){this.closeListener=e}connect(e){return t=this,r=void 0,i=function*(){var t,r,s,i,n;try{console.log("fetch");const n=yield fetch(this.url,{method:"POST",headers:this.headers,body:JSON.stringify(e)});n.ok?null===(r=this.openListener)||void 0===r||r.call(this,n):null===(t=this.errorListener)||void 0===t||t.call(this,n);const o=n.body;let l,c="";for(this.reader=o.getReader();!(l=yield this.reader.read()).done;){let e=new TextDecoder("utf-8").decode(l.value);c+=e;let t=c.indexOf("\n\n");if(t>-1){let r=c.substring(0,t);if(c=c.substring(t+2),r.startsWith(":")){const t=e.split("\n");for(const e of t){const t=e.split(":");3==t.length&&(this.properties[t[1].trim()]=t[2].trim())}}else{let e=r.indexOf(":");if(e>-1){let t=r.substring(0,e).trim();" "===r[e+1]&&e++,e++;let i=r.substring(e).replace(/\ndata: ?/g,"\n");"data"===t?null===(s=this.messageListener)||void 0===s||s.call(this,i):console.warn(`Not supported message with type of message ${t}: ${i}`)}}}}null===(i=this.closeListener)||void 0===i||i.call(this,"Connection closed")}catch(e){null===(n=this.errorListener)||void 0===n||n.call(this,e)}},new((s=void 0)||(s=Promise))((function(e,n){function o(e){try{c(i.next(e))}catch(e){n(e)}}function l(e){try{c(i.throw(e))}catch(e){n(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(e){e(r)}))).then(o,l)}c((i=i.apply(t,r||[])).next())}));var t,r,s,i}disconnect(){var e;null===(e=this.reader)||void 0===e||e.cancel()}getProperty(e){return this.properties[e]}getProperties(){return this.properties}}const c="FALSE",a="TRUE",u="add",h="remove";class d{constructor(e){this.queries=new Map,this.globalListener=e}calculateFilter(e,t,r){return{action:e,queries:[t],initialData:r.querySets.some((e=>e.initialData&&0===e.count))?a:void 0,once:r.querySets.every((e=>e.once))?a:void 0,compress:r.querySets.some((e=>e.compress))?a:void 0}}increment(e){for(const t of e.querySets)t.count++}tryToRemove(e,t){if(e.querySets.every((e=>e.once)))return this.queries.delete(t),{action:h,queries:[t]}}equalFiltersWithoutQueries(e,t){return e.action===t.action&&e.compress===t.compress&&e.initialData===t.initialData&&e.once===t.once}addQueries(e,t,r,s,i){let n=[];for(const o of e){let e=this.queries.get(o.query);if(e){let l=this.calculateFilter(u,o.query,e),c=e.querySets.find((e=>e.querySet===i));if(c)c.initialData=t,c.once=r,c.compress=s,t&&(c.count=0),-1==c.callbacks.indexOf(o.listener)&&c.callbacks.push(o.listener),-1==c.errorCallbacks.indexOf(o.errorListener)&&c.errorCallbacks.push(o.errorListener);else{let n=[];o.listener&&n.push(o.listener);let l=[];o.errorListener&&l.push(o.errorListener),e.querySets.push({querySet:i,initialData:t,compress:s,once:r,count:0,callbacks:o.listener?[o.listener]:[],errorCallbacks:o.errorListener?[o.errorListener]:[]})}let a=this.calculateFilter(u,o.query,e);if(!this.equalFiltersWithoutQueries(l,a)){let e=n.find((e=>this.equalFiltersWithoutQueries(e,a)));e?e.queries.push(o.query):n.push(a)}}else{let e={querySets:[{querySet:i,initialData:t,compress:s,once:r,count:0,callbacks:o.listener?[o.listener]:[],errorCallbacks:o.errorListener?[o.errorListener]:[]}]};this.queries.set(o.query,e);let l=this.calculateFilter(u,o.query,e),c=n.find((e=>this.equalFiltersWithoutQueries(e,l)));c?c.queries.push(o.query):n.push(l)}}return n}filterForQuery(e){return this.queries.get(e)}removeAllQueries(e){let t=Array.from(this.queries.keys());return this.removeQueries(t,e)}removeQueries(e,t){let r=[];for(const s of e){let e=!0,i=this.queries.get(s);if(i){let r=i.querySets.findIndex((e=>e.querySet===t));r>-1&&i.querySets.splice(r,1),i.querySets.length&&(e=!1)}e&&(this.queries.delete(s),r.push(s))}if(r.length)return{action:h,queries:r}}activeFilters(){let e=[];for(const[t,r]of this.queries){const s=this.calculateFilter(u,t,r);let i=e.find((e=>this.equalFiltersWithoutQueries(e,s)));i?i.queries.push(t):e.push(s)}return e}handleErrorListeners(e,t,r){for(let s of e)try{s(r)}catch(e){console.warn(`Error while handling error listener for query: ${t}`,e)}}handleGlobalListener(e){var t;try{null===(t=this.globalListener)||void 0===t||t.call(this,e)}catch(e){console.warn("Error while handling global error listener",e)}}}class f{constructor(e,t){this.opened=!1,this.config=e,this.filtersState=t,this.url=`https://${this.config.host}/api/es/sse/v1/subscribe`,this.headers={"Content-Type":"application/json",Authorization:`${this.config.apiKey}`,"x-customer-id":`${this.config.customerId}`}}send(e){if(e&&this.opened){this.disconnect();let e=this.filtersState.activeFilters();console.log("sent message to subscribe"),this.retrieve(e)}}connect(){var e;if(this.opened)throw Error("SSE connection already opened");this.opened=!0,console.log("SSE open"),null===(e=this.openListener)||void 0===e||e.call(this,"SSE connection opened")}retrieve(e){var t;this.opened||(this.opened=!0,console.log("SSE open"),null===(t=this.openListener)||void 0===t||t.call(this,"SSE connection opened"));let r=e.filter((e=>e.initialData===a)).map((e=>e.queries)).reduce(((e,t)=>e.concat(t)),[]);if(!r.length)return void this.subscribe(e);let i={type:"collection",fabric:this.config.fabric,filters:{once:a,compress:c,initialData:a,queries:r}},n=this;this.eventSource=new l(this.url,this.headers),this.eventSource.onError((e=>{const t={type:s.ClientGlobalError,connection:n,data:e};this.filtersState.handleGlobalListener(t)})),this.eventSource.onMessage((t=>{var r;n.handleMessage(t)&&(null===(r=n.eventSource)||void 0===r||r.disconnect(),n.subscribe(e))})),this.eventSource.connect(i)}subscribe(e){var t;this.opened||(this.opened=!0,console.log("SSE open"),null===(t=this.openListener)||void 0===t||t.call(this,"SSE connection opened"));let r=e.filter((e=>e.once!==a)).map((e=>e.queries)).reduce(((e,t)=>e.concat(t)),[]);if(!r.length)return;let i={type:"collection",fabric:this.config.fabric,filters:{once:c,compress:c,initialData:c,queries:r}},n=this;this.eventSource=new l(this.url,this.headers),this.eventSource.onError((e=>{const t={type:s.ClientGlobalError,connection:n,data:e};this.filtersState.handleGlobalListener(t)})),this.eventSource.onMessage((e=>{n.handleMessage(e)})),this.eventSource.onClose((e=>{var t;console.log("close es"),this.opened&&(this.opened=!1,console.log("SSE close"),null===(t=n.closeListener)||void 0===t||t.call(n,e))})),this.eventSource.connect(i)}onOpen(e){this.openListener=e}onMessage(e){this.messageListener=e}onClose(e){this.closeListener=e}onError(e){this.errorListener=e}status(){return i.Closed}disconnect(){var e;null===(e=this.eventSource)||void 0===e||e.disconnect(),this.eventSource=void 0}getId(){return this.getProperty(r)}getProperty(e){var t;return null===(t=this.eventSource)||void 0===t?void 0:t.getProperty(e)}getProperties(){return this.eventSource?this.eventSource.getProperties():{}}handleMessage(e){let t=JSON.parse(e);if(!t.error){for(let e in t){let r=t[e],i=this.filtersState.filterForQuery(e);if(i){this.filtersState.increment(i);let t=Array.isArray(r);if(t)for(let e=0;e<r.length;e++)r[e]=n(r[e]);else r=[r];for(const n of i.querySets){if(t&&!n.initialData)continue;let i={type:s.Message,connection:this,data:r,query:e,count:n.count,retrieve:t};for(let t of n.callbacks)try{t(i)}catch(t){let r=`Error while handling data for query: ${e}`;const i={type:s.ClientQueryError,connection:this,data:t,message:r,query:e};this.filtersState.handleErrorListeners(n.errorCallbacks,e,i)}}this.filtersState.tryToRemove(i,e)}}return!0}{let e=t.error;const r="Error parsing SQL query:";if(e.startsWith(r)){let i=e.substring(r.length,e.indexOf("ERROR")).trim();const n={type:s.ServerQueryError,connection:this,data:void 0,code:t.code,message:e,query:i};let o=this.filtersState.filterForQuery(i);if(o)for(const e of o.querySets)this.filtersState.handleErrorListeners(e.errorCallbacks,i,n)}else{const r={type:s.ServerGlobalError,connection:this,data:void 0,code:t.code,message:e};this.filtersState.handleGlobalListener(r)}}return!1}}class p{constructor(e,t,r){this.subscribeQueries=[],this.retrieveAndSubscribeQueries=[],this.retrieveQueries=[],this.unsubscribeQueries=[],this.querySet=e,this.connection=t,this.filtersState=r}subscribe(e,t,r){return this.subscribeQueries.push({query:e,listener:t,errorListener:r,compress:!1}),this}retrieveAndSubscribe(e,t,r,s){return this.retrieveAndSubscribeQueries.push({query:e,listener:t,errorListener:r,compress:!0===s}),this}retrieve(e,t,r,s){return this.retrieveQueries.push({query:e,listener:t,errorListener:r,compress:!0===s}),this}unsubscribe(e){return this.unsubscribeQueries.push(e),this}assemble(){let e=this.filtersState.addQueries(this.retrieveQueries,!0,!0,!1,this.querySet),t=this.filtersState.addQueries(this.retrieveAndSubscribeQueries,!0,!1,!1,this.querySet);this.joinFilters(e,t);let r=this.filtersState.addQueries(this.subscribeQueries,!1,!1,!1,this.querySet);this.joinFilters(e,r);for(const t of e)this.connection.send(t);let s=this.filtersState.removeQueries(this.unsubscribeQueries,this.querySet);s&&this.connection.send(s)}joinFilters(e,t){for(const r of t){let t=e.find((e=>this.filtersState.equalFiltersWithoutQueries(e,r)));t?t.queries.push(...r.queries):e.push(r)}}}class v{constructor(e,t){this.connection=e,this.filtersState=t}subscribe(e,t,r){let s=[{query:e,listener:t,errorListener:r,compress:!1}],i=this.filtersState.addQueries(s,!1,!1,!1,this);for(const e of i)this.connection.send(e)}retrieveAndSubscribe(e,t,r,s){let i=[{query:e,listener:t,errorListener:r,compress:!0===s}],n=this.filtersState.addQueries(i,!0,!1,!0===s,this);for(const e of n)this.connection.send(e)}retrieve(e,t,r,s){let i=[{query:e,listener:t,errorListener:r,compress:!0===s}],n=this.filtersState.addQueries(i,!0,!0,!0===s,this);for(const e of n)this.connection.send(e)}unsubscribe(e){let t=this.filtersState.removeQueries([e],this);t&&this.connection.send(t)}unsubscribeAll(){let e=this.filtersState.removeAllQueries(this);e&&this.connection.send(e)}batch(){return new p(this,this.connection,this.filtersState)}}class g{constructor(e,t){this.connectionTypes=["ws"],this.reconnection=-1,this.config=e,this.filtersState=new d(t)}connect(){var e;if(console.log("switchable conn"),this.connection)throw new Error(`Already connected with status: ${this.status()}`);(null===(e=this.config.connectionTypes)||void 0===e?void 0:e.length)&&(this.connectionTypes=this.config.connectionTypes);let t=this.connectionTypes[this.reconnection%this.connectionTypes.length];switch(t){case"ws":this.connection=new o(this.config,this.filtersState);break;case"sse":this.connection=new f(this.config,this.filtersState);break;default:throw new Error(`Connection type not supported: ${t}`)}let r=this;this.connection.onOpen((function(e){var t;let i=r.reconnection;if(r.reconnection=0,-1===i){const t={type:s.Open,connection:r,data:e};r.filtersState.handleGlobalListener(t)}let n=r.filtersState.activeFilters();for(const e of n)null===(t=r.connection)||void 0===t||t.send(e)})),this.connection.onMessage((function(e){})),this.connection.onError((function(e){})),this.connection.onClose((function(e){if(r.connection=void 0,r.reconnection>-1){let e=Math.pow(2,6+r.reconnection++);console.log("connect es"),setTimeout((function(){r.connect()}),e)}else{r.reconnection=0;const t={type:s.Close,connection:r,data:e};r.filtersState.handleGlobalListener(t)}})),this.connection.connect()}send(e){var t;null===(t=this.connection)||void 0===t||t.send(e)}disconnect(){var e;this.reconnection=-1,null===(e=this.connection)||void 0===e||e.disconnect()}getConfig(){return this.config}status(){return this.connection?this.connection.status():i.Closed}getId(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getId()}getProperty(e){var t;return null===(t=this.connection)||void 0===t?void 0:t.getProperty(e)}getProperties(){return this.connection?this.connection.getProperties():{}}querySet(){return new v(this,this.filtersState)}}function y(e,t){return new g(e,t)}function S(e,t){let r=new g(e,t);return r.connect(),r}return t})()));